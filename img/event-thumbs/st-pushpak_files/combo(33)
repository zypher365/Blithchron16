YUI.add("album-route",function(e){function i(e){i.superclass.constructor.call(this,e)}var t=25,n=50,r=100;e.Routes[this.name]=i,e.extend(i,e.FlickrRoute,{langBundles:this.details.langBundles,run:function(i){var s=this,o={},u,a="/photos/"+i.params.nsid_or_path_alias+"/albums/"+i.params.set_id+"/",f=i.params&&i.params.photo_id,l=f?r:t,c=this.getPageNumber(i),h=i.headers?i.headers["user-agent"]:!1,p=i.query?i.query:{},d,v=!1,m=i.params.nsid_or_path_alias,g=[],y;return h&&h.match(/^Twitterbot/i)!==null&&(v=!0),o.id=i.params.set_id,u={page:r/l*(c-1)+1,perPage:l,withPhotoId:f},g.push(this.appContext.getModel("set-models",o,u)),this.appContext.getViewer().signedIn||i.probableUser?g.push(this.appContext.getModel("person-preferences-models",this.appContext.getViewer().signedIn?this.appContext.getViewer().nsid:i.probableUser)):d=p.layout?p.layout:"story",e.Promise.all(g).then(null,function(e){if(e.getModelFailure&&i.probableUser)return i.probableUser=null,[];throw e}).then(function(t){var o=0,l=t[0];t[1]&&(d=t[1].getValue("albumViewLayoutPref"));if(YUI.Env.isServer){o=Math.ceil(l.getValue("totalCount")/r);if(c>o&&u.page>1&&!isNaN(parseInt(i.params.page_number,10)))return e.Promise.resolve({redirect:a.replace(/page[0-9]+/,"")})}if(f){var h=l.getValue("photoPageList");y=h.getPageOf({id:f},n);if(y===-1||h.getNextIncompletePage(u)===y)return u.forceAPICall=!0,h.getPage(u).then(function(e){return c=Math.ceil(h.getPageOf({id:f},n)*n/r),c===0&&(c=0),y=c,s.onRouteResolved(l,c,y,a,f,v,d,m)},function(e){return e.code===2?(c=s.getPageNumber(i),y=r/n*(c-1)+1,s.onRouteResolved(l,c,y,a,f,v,d,m)):s.onRouteRejected(e,i)});c=Math.ceil(h.getPageOf({id:f},n)*n/r),y=c}else y=r/n*(c-1)+1;return s.onRouteResolved(l,c,y,a,f,v,d,m)}).catch(function(t){return t.code===2?e.Promise.resolve({redirect:a}):s.onRouteRejected(t,i)})},onRouteResolved:function(t,i,s,o,u,a,f,l){var c={idAttribute:"id",page:s,perPage:u?r:n,viewPageSizeForShare:r,nominalPage:i};return this.appContext.flipper.isFlipped("enable-album-pagination")&&(c.viewPageSize=r),e.Promise.resolve({view:"album-page-view",fluid:!0,layout:"scrolling",title:t.getValue("title"),params:{albumId:t.id,nsid:t.getValue("owner").getValue("nsid"),baseURL:o,isTwitterbot:a,albumPhotoListLayoutStyle:f,withPhotoId:u,nsidOrPathAlias:l,pageParams:c}})},onRouteRejected:function(t,n){var r="Couldn't load album page";t.message&&(r+=": "+t.message);if(t.fatal)throw t;return this.displayRouteErrors(n,new e.RouteError(404,r))}})},"@VERSION@",{requires:["flickr-route","flickr-promise","set-models","person-preferences-models"]});
